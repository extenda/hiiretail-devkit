services:
  mockserver:
    image: mockserver/mockserver:5.15.0
    # No external port - accessed only via validation-proxy
    environment:
      MOCKSERVER_LOG_LEVEL: INFO
      MOCKSERVER_ENABLE_CORS_FOR_ALL_RESPONSES: "true"
    networks:
      - devkit

  # One-shot container: waits for MockServer, then loads OpenAPI expectations
  mockserver-init:
    image: extenda/hiiretail-devkit-mockserver-init:latest
    build:
      context: .
      dockerfile: mockserver/init/Dockerfile
    depends_on:
      mockserver:
        condition: service_started
    environment:
      MOCKSERVER_URL: http://mockserver:1080
    volumes:
      - swagger-specs:/output/specs
    networks:
      - devkit

  # Validation proxy: validates requests against OpenAPI schemas before forwarding
  validation-proxy:
    image: extenda/hiiretail-devkit-validation-proxy:latest
    build:
      context: .
      dockerfile: validation-proxy/Dockerfile
    ports:
      - "${MOCKSERVER_PORT:-1080}:1080"
    depends_on:
      mockserver-init:
        condition: service_completed_successfully
    environment:
      PORT: 1080
      MOCKSERVER_URL: http://mockserver:1080
      SPECS_DIR: /specs
    volumes:
      - swagger-specs:/specs:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:1080/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  webhook-receiver:
    image: extenda/hiiretail-devkit-webhook-receiver:latest
    build:
      context: .
      dockerfile: webhook-receiver/Dockerfile
    ports:
      - "${WEBHOOK_RECEIVER_PORT:-3002}:3002"
    environment:
      PORT: 3002
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  webhook-playground:
    image: extenda/hiiretail-devkit-webhook-playground:latest
    build:
      context: .
      dockerfile: webhook-playground/Dockerfile
    ports:
      - "${WEBHOOK_PLAYGROUND_PORT:-8081}:8081"
    environment:
      PORT: 8081
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  swagger-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    ports:
      - "${SWAGGER_UI_PORT:-8080}:8080"
    depends_on:
      mockserver-init:
        condition: service_completed_successfully
    environment:
      URL: "/specs/item-input.json"
      URLS: >-
        [
          {"url": "/specs/item-input.json", "name": "Item Input API"},
          {"url": "/specs/price-specification-input.json", "name": "Price Specification Input API"},
          {"url": "/specs/item-identifier-input.json", "name": "Item Identifier Input API"},
          {"url": "/specs/business-unit.json", "name": "Business Unit Management API"},
          {"url": "/specs/item-category-input.json", "name": "Item Category Input API"}
        ]
      URLS_PRIMARY_NAME: "Item Input API"
    volumes:
      - swagger-specs:/usr/share/nginx/html/specs:ro
    networks:
      - devkit

volumes:
  swagger-specs:

networks:
  devkit:
    driver: bridge
