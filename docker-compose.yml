services:
  mockserver:
    image: mockserver/mockserver:5.15.0
    ports:
      - "${MOCKSERVER_PORT:-1080}:1080"
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/expectations/init-expectations.json
      MOCKSERVER_LOG_LEVEL: INFO
      MOCKSERVER_ENABLE_CORS_FOR_ALL_RESPONSES: "true"
    volumes:
      - ./mockserver:/config:ro
    networks:
      - devkit

  # One-shot container: waits for MockServer, then fetches OpenAPI specs and loads expectations
  mockserver-init:
    image: extenda/hiiretail-devkit-mockserver-init:latest
    build:
      context: ./mockserver/init
      dockerfile: Dockerfile
    depends_on:
      mockserver:
        condition: service_started
    environment:
      MOCKSERVER_URL: http://mockserver:1080
    volumes:
      - ./specs:/specs:ro
      - swagger-specs:/output/specs
    networks:
      - devkit

  webhook-receiver:
    image: extenda/hiiretail-devkit-webhook-receiver:latest
    build:
      context: ./webhook-receiver
      dockerfile: Dockerfile
    ports:
      - "${WEBHOOK_RECEIVER_PORT:-3002}:3002"
    environment:
      PORT: 3002
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  webhook-playground:
    image: extenda/hiiretail-devkit-webhook-playground:latest
    build:
      context: ./webhook-playground
      dockerfile: Dockerfile
    ports:
      - "${WEBHOOK_PLAYGROUND_PORT:-8081}:8081"
    environment:
      PORT: 8081
      EVENTS_DIR: /events
    volumes:
      - ./webhooks/events:/events:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  swagger-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    ports:
      - "${SWAGGER_UI_PORT:-8080}:8080"
    depends_on:
      mockserver-init:
        condition: service_completed_successfully
    environment:
      URL: "/specs/item-input.json"
      URLS: >-
        [
          {"url": "/specs/item-input.json", "name": "Item Input API"},
          {"url": "/specs/price-specification-input.json", "name": "Price Specification Input API"},
          {"url": "/specs/item-identifier-input.json", "name": "Item Identifier Input API"},
          {"url": "/specs/business-unit.json", "name": "Business Unit Management API"},
          {"url": "/specs/item-category-input.json", "name": "Item Category Input API"}
        ]
      URLS_PRIMARY_NAME: "Item Input API"
    volumes:
      - swagger-specs:/usr/share/nginx/html/specs:ro
    networks:
      - devkit

volumes:
  swagger-specs:

networks:
  devkit:
    driver: bridge
