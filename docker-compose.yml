services:
  mockserver:
    image: mockserver/mockserver:5.15.0
    ports:
      - "${MOCKSERVER_PORT:-1080}:1080"
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/expectations/init-expectations.json
      MOCKSERVER_LOG_LEVEL: INFO
      MOCKSERVER_ENABLE_CORS_FOR_ALL_RESPONSES: "true"
    volumes:
      - ./mockserver:/config:ro
    networks:
      - devkit

  # One-shot container: waits for MockServer, then fetches OpenAPI specs and loads expectations
  mockserver-init:
    build:
      context: ./mockserver/init
      dockerfile: Dockerfile
    depends_on:
      mockserver:
        condition: service_started
    environment:
      MOCKSERVER_URL: http://mockserver:1080
    volumes:
      - ./specs:/specs:ro
    networks:
      - devkit

  webhook-receiver:
    build:
      context: ./webhook-receiver
      dockerfile: Dockerfile
    ports:
      - "${WEBHOOK_RECEIVER_PORT:-3002}:3002"
    environment:
      PORT: 3002
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  webhook-playground:
    build:
      context: ./webhook-playground
      dockerfile: Dockerfile
    ports:
      - "${WEBHOOK_PLAYGROUND_PORT:-8081}:8081"
    environment:
      PORT: 8081
      EVENTS_DIR: /events
    volumes:
      - ./webhooks/events:/events:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - devkit

  swagger-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    ports:
      - "${SWAGGER_UI_PORT:-8080}:8080"
    environment:
      URLS: >-
        [
          {"url": "https://developer.hiiretail.com/swagger/item-input-api", "name": "Item Input API"},
          {"url": "https://developer.hiiretail.com/swagger/price-specification-input-api", "name": "Price Specification Input API"},
          {"url": "https://developer.hiiretail.com/swagger/item-identifier-input-api", "name": "Item Identifier Input API"},
          {"url": "https://developer.hiiretail.com/swagger/business-unit-api", "name": "Business Unit Management API"},
          {"url": "https://developer.hiiretail.com/swagger/item-category-input-api", "name": "Item Category Input API"}
        ]
    networks:
      - devkit

networks:
  devkit:
    driver: bridge
